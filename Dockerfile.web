# ====================================================
# Dockerfile para o Frontend (Next.js Web)
# Build context: raiz do monorepo
# ====================================================

FROM node:20-alpine AS builder
WORKDIR /app

# Copia todo o workspace
COPY . .

# Instala dependências
RUN npm install

# Gera o Prisma Client (necessário para o `transpilePackages`)
RUN cd packages/database && npx prisma generate

# Build do Next.js (usa o output standalone configurado no next.config.js)
RUN cd apps/web && npm run build

# ====================================================
FROM node:20-alpine AS runner
WORKDIR /app

ENV NODE_ENV=production
ENV PORT=3000

# Next.js standalone inclui server.js + arquivos estáticos
COPY --from=builder /app/apps/web/.next/standalone ./
COPY --from=builder /app/apps/web/.next/static ./apps/web/.next/static
# Adiciona verificação para copiar a pasta public apenas se ela existir (fallback para nçao quebrar a build)
# O Next standalone espera a public no root do app web (onde fica o server.js)
COPY --from=builder /app/apps/web/public ./apps/web/public/

EXPOSE 3000

CMD ["node", "apps/web/server.js"]
